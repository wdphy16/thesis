%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%       Exact Sampling for Classical and Quantum Many-Body Systems
%
%       Based on the EPFL EDOC Template
%       2024
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% LTeX: enabled=false

\documentclass[a4paper,11pt]{book}

\usepackage{iftex}
\ifxetex
\else
    \pdfoutput=1
    \usepackage[T1]{fontenc}
    \usepackage[utf8]{inputenc}
\fi

% Load setspace before hyperref https://github.com/schlcht/microtype/issues/11
\usepackage{setspace} % increase interline spacing slightly
\setstretch{1.1}

\usepackage{doi}
\usepackage[autostyle]{csquotes}
\usepackage[
    backend=biber,
    style=numeric-comp,
    date=year,
    giveninits=true,
    sorting=none,
    url=false,
    doi=true,
    eprint=true,
]{biblatex}
\addbibresource{tail/bibliography.bib}

\usepackage[french,english]{babel}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% EDOC THESIS TEMPLATE: Variant 1.0 -> Latin modern, large text width & height
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \usepackage{lmodern} % use this to fix blurry typewriter text font
% \usepackage[a4paper,top=22mm,bottom=28mm,inner=35mm,outer=25mm]{geometry}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% EDOC THESIS TEMPLATE: Variant 2.0 -> Utopia, Gabarrit A (lighter pages)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\ifxetex
    \usepackage{mathtools}
    \usepackage{unicode-math}
    \setmathfont{Erewhon Math}
    \usepackage{erewhon}
\else
    \usepackage{fourier} % Utopia font-typesetting including mathematical formula compatible with newer TeX-Distributions (> 2010)
    % \usepackage{utopia} % on older systems -> use this package instead of fourier in combination with mathdesign for better looking results
    % \usepackage[adobe-utopia]{mathdesign}
\fi
\setlength{\textwidth}{146.8mm} % = 210mm - 37mm - 26.2mm
\setlength{\oddsidemargin}{11.6mm} % 37mm - 1in (from hoffset)
\setlength{\evensidemargin}{0.8mm} % = 26.2mm - 1in (from hoffset)
\setlength{\topmargin}{-2.2mm} % = 0mm - 1in + 23.2mm
\setlength{\textheight}{221.9mm} % = 297mm - 29.5mm - 31.6mm - 14mm (12 to accomodate footline with pagenumber)
\setlength{\headheight}{14mm}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter
\setlength{\@fptop}{0pt} % for aligning all floating figures/tables etc... to the top margin
\makeatother

\usepackage{graphicx}
\usepackage{xcolor}
\graphicspath{{images/}}

\usepackage{booktabs}
\usepackage{lipsum}
\ifxetex
\else
    \usepackage{microtype}
\fi
\usepackage{subfig}
\usepackage{url}

\usepackage{fancyhdr}
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}
\pagestyle{fancy}
    \fancyhf{}
    \renewcommand{\headrulewidth}{0.4pt}
    \renewcommand{\footrulewidth}{0pt}
    \fancyhead[OR]{\bfseries \nouppercase{\rightmark}}
    \fancyhead[EL]{\bfseries \nouppercase{\leftmark}}
    \fancyfoot[EL,OR]{\thepage}
\fancypagestyle{plain}{
    \fancyhf{}
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\footrulewidth}{0pt}
    \fancyfoot[EL,OR]{\thepage}
}
\fancypagestyle{addpagenumbersforpdfimports}{
    \fancyhead{}
    \renewcommand{\headrulewidth}{0pt}
    \fancyfoot{}
    \fancyfoot[RO,LE]{\thepage}
}

\usepackage{listings}
\lstset{
    language=[LaTeX]Tex,
    tabsize=4,
    basicstyle=\scriptsize\ttfamily,
    showstringspaces=false,
    numbers=left,
    numberstyle=\tiny,
    numbersep=10pt,
    breaklines=true,
    breakautoindent=true,
    breakindent=10pt,
}

\usepackage{hyperref}
\hypersetup{
    pdfborder={0 0 0},
    colorlinks=true,
    linkcolor=black,
    citecolor=black,
    urlcolor=black,
}
\urlstyle{same}
\ifxetex
\else
    \ifpdf
        \usepackage[final]{pdfpages}
    \else
        \usepackage{breakurl}
        \usepackage{calc}
        \usepackage[nlwarning=false]{hypdvips}
        \usepackage{backref}
        \renewcommand*{\bacref}[1]{}
    \fi
\fi
\usepackage{bookmark}

\makeatletter
\renewcommand\@pnumwidth{20pt}
\makeatother

\makeatletter
\def\cleardoublepage{
    \clearpage
    \if@twoside
        \ifodd
            \c@page
        \else
            \hbox{}
            \thispagestyle{empty}
            \newpage
            \if@twocolumn
                \hbox{}
                \newpage
            \fi
        \fi
    \fi
}
\makeatother
\clearpage{\pagestyle{plain}\cleardoublepage}

%%%%% CHAPTER HEADER %%%%
\usepackage{color}
\usepackage{tikz}
\usepackage[explicit]{titlesec}
\newcommand*\chapterlabel{}
% \renewcommand{\thechapter}{\Roman{chapter}}
\titleformat{\chapter}[display] % type (section, chapter, etc...) to vary, shape (eg display-type)
    {\normalfont\bfseries\Huge} % format of the chapter
    {\gdef\chapterlabel{\thechapter\ }} % the label
    {0pt} % separation between label and chapter-title
    {
    \ifxetex
        \setlength{\unitlength}{9mm}
    \else
        \setlength{\unitlength}{0mm}
    \fi
    \begin{tikzpicture}[remember picture,overlay]
        \node[yshift=-8cm] at (current page.north west)
        {\begin{tikzpicture}[remember picture,overlay]
            \draw[fill=black] (0,0) rectangle(35.5mm,15mm);
            \node[anchor=north east,yshift=-7.2cm-\unitlength,xshift=34mm,minimum height=30mm,inner sep=0mm] at (current page.north west)
                {\parbox[top][30mm][t]{15mm}{\raggedleft \rule{0cm}{0.6cm}\color{white}\chapterlabel}}; % the empty rule is just to get better base-line alignment
            \node[anchor=north west,yshift=-7.2cm-\unitlength,xshift=37mm,text width=\textwidth,minimum height=30mm,inner sep=0mm] at (current page.north west)
                {\parbox[top][30mm][t]{\textwidth}{\rule{0cm}{0.6cm}\color{black}#1}};
        \end{tikzpicture}};
    \end{tikzpicture}
    \gdef\chapterlabel{}
    } % code before the title body
\titlespacing*{name=\chapter,numberless}{-3.7cm}{83.2pt-\parskip}{-3.2pt+\parskip}
\titlespacing*{\chapter}{-3.7cm}{50pt-\parskip-\parskip}{30pt+\parskip+\parskip}

\titlespacing*{\section}{0pt}{13.2pt}{1em-\parskip} % 13.2pt is line spacing for a text with 11pt font size
\titlespacing*{\subsection}{0pt}{13.2pt}{1em-\parskip}
\titlespacing*{\subsubsection}{0pt}{13.2pt}{1em-\parskip}
\titlespacing*{\paragraph}{0pt}{13.2pt}{1em-\parskip}

\newcounter{myparts}
\newcommand*\partlabel{}
\titleformat{\part}[display] % type (section, chapter, etc...) to vary, shape (eg display-type)
    {\normalfont\bfseries\Huge} % format of the part
    {\gdef\partlabel{\thepart\ }} % the label
    {0pt} % separation between label and part-title
    {
    \ifxetex
        \setlength{\unitlength}{20mm}
    \else
        \ifpdf
            \setlength{\unitlength}{20mm}
        \else
            \setlength{\unitlength}{0mm}
        \fi
    \fi
    \addtocounter{myparts}{1}
    \begin{tikzpicture}[remember picture,overlay]
        \node[anchor=north west,xshift=-65mm,yshift=-6.9cm-\value{myparts}*20mm] at (current page.north east) % for unknown reasons: 3mm missing -> 65 instead of 62
        {\begin{tikzpicture}[remember picture,overlay]
            \draw[fill=black] (0,0) rectangle(62mm,20mm); % -\value{myparts}*\unitlength
            \node[anchor=north west,yshift=-6.1cm-\value{myparts}*\unitlength,xshift=-60.5mm,minimum height=30mm,inner sep=0mm] at (current page.north east)
                {\parbox[top][30mm][t]{55mm}{\raggedright \color{white}Part \partlabel \rule{0cm}{0.6cm}}}; % the empty rule is just to get better base-line alignment
            \node[anchor=north east,yshift=-6.1cm-\value{myparts}*\unitlength,xshift=-63.5mm,text width=\textwidth,minimum height=30mm,inner sep=0mm] at (current page.north east)
                {\parbox[top][30mm][t]{\textwidth}{\raggedleft \rule{0cm}{0.6cm}\color{black}#1}};
        \end{tikzpicture}};
    \end{tikzpicture}
    \gdef\partlabel{}
    } % code before the title body
\titlespacing*{\part}{11.06cm}{26.4pt-\parskip-\parskip}{0pt}

\ifxetex
\else
    \usepackage{amsfonts}
    \usepackage{amsmath}
    \usepackage{amssymb}
    \usepackage{mathtools}
    % Fix the problem with delimiter size caused by fourier and amsmath packages.
    \makeatletter
    \def\resetMathstrut@{%
        \setbox\z@\hbox{%
            \mathchardef\@tempa\mathcode`\(\relax
            \def\@tempb##1"##2##3{\the\textfont"##3\char"}%
            \expandafter\@tempb\meaning\@tempa \relax
        }%
        \ht\Mathstrutbox@1.2\ht\z@ \dp\Mathstrutbox@1.2\dp\z@
    }
    \makeatother
\fi

\ifxetex
    \newcommand{\bm}[1]{\symbfit{#1}}
\else
    \usepackage{bm}
\fi

\usepackage[capitalize]{cleveref}
\usepackage{physics}

\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{makecell}
\usepackage[framemethod=TikZ]{mdframed}
\usepackage{pdflscape}

\DeclareFieldFormat[article,inbook,incollection,inproceedings,patent,thesis,unpublished,techreport,misc,book]{title}{\mkbibquote{#1}}

\mdfdefinestyle{summarybox}{
    roundcorner=10pt,
    innertopmargin=0.5\topskip,
    frametitle={Summary},
    frametitlerule=true,
    frametitlebackgroundcolor=gray!20,
}
\mdfdefinestyle{paperbox}{
    roundcorner=10pt,
    innertopmargin=0.5\topskip,
    frametitle={Note},
    frametitlerule=true,
    frametitlebackgroundcolor=gray!20,
}

\newcommand{\summary}[1]{
    \begin{mdframed}[style=summarybox]
    #1
    \end{mdframed}
}
\newcommand{\paper}[1]{
    \begin{mdframed}[style=paperbox]
    #1
    \end{mdframed}
}
\newcommand{\comment}[1]{}
\newcommand{\printpublication}[1]{\AtNextCite{\defcounter{maxnames}{99}}\fullcite{#1}}

\renewcommand{\algorithmiccomment}[1]{\hfill\textcolor{gray}{// #1}}
\renewcommand{\algorithmicrequire}{\textbf{Input:}}
\renewcommand{\algorithmicensure}{\textbf{Output:}}

% use nice, default version of mathcal
\DeclareMathAlphabet{\mathcal}{OMS}{cmsy}{m}{n}

\DeclareSourcemap{
    \maps[datatype=bibtex]{
        \map{
            \step[fieldsource=doi,final]
            \step[fieldset=isbn,null]
        }
    }
}
\DeclareSourcemap{
    \maps[datatype=bibtex]{
        \map{
            \step[fieldsource=doi,final]
            \step[fieldset=issn,null]
        }
    }
}
\DeclareSourcemap{
    \maps[datatype=bibtex]{
        \map{
            \pertype{incollection}
            \step[fieldset=address,null]
            \step[fieldset=publisher,null]
        }
    }
}
\DeclareSourcemap{
    \maps[datatype=bibtex]{
        \map{
            \pertype{inproceedings}
            \step[fieldset=address,null]
            \step[fieldset=publisher,null]
            \step[fieldset=location,null]
            \step[fieldset=series,null]
        }
    }
}

\AtEveryBibitem{\clearfield{pages}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% HEAD: Book-Begin
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\frontmatter
\input{head/def}
\input{head/titlepage}
% \include{head/dedication}
\setcounter{page}{0}
% \include{head/abstracts} % TODO
\include{head/publications}
% \include{head/acknowledgements} % TODO

\cleardoublepage
\pdfbookmark{\contentsname}{toc}
\tableofcontents

\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{List of Figures}
\listoffigures

% \cleardoublepage
% \phantomsection
% \addcontentsline{toc}{chapter}{List of Tables} % TODO
% \listoftables

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% BODY: The chapters of the thesis
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\mainmatter
\part{Introduction}
\include{body/ch1_intro}
\include{body/ch2_systems}
\part{Computational techniques for classical systems}
\include{body/ch3_mcmc}
\include{body/ch4_var}
\include{body/ch5_arnn}
\part{Computational techniques for quantum systems}
\include{body/ch6_qmc}
\include{body/ch7_vmc}
\include{body/ch8_tn}

\addtocontents{toc}{\vspace{\normalbaselineskip}}
\cleardoublepage
\bookmarksetup{startatroot}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% TAIL: Bibliography, Appendix, CV
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\include{tail/appendix}
\backmatter
\include{tail/biblio}
% \include{tail/cv} % TODO
\end{document}
